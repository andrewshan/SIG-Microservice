# Router（路由）

[English](./router.md) | 简体中文

---

## 定义

通常一个服务包含多个实例。在简单场景下，每个实例是对等的，通过负载均衡组件访问任意一个即可

但是，在绝大部分场景下，每个实例具有逻辑属性和物理属性：

- 逻辑属性：版本、协议、业务Set、特性环境等。允许用户为每个实例设置自定义标签
- 物理属性：地理位置。公司CMDB获取每个实例的地域-城市-园区信息
- 
对于某个服务的全部实例，可以根据逻辑和物理属性将其划分成为多个分组或者集群，如下图所示：

![router-image-1](./image/router-image-1.png)

服务主调方/消费者发送请求，动态路由组件根据请求和主调方节点属性，将不同节点的不同请求路由到不同实例分组或者集群


### 入流量

入流量规则代表的是当服务作为被调方时，控制所有主调方进行流量转发的规则。

![router-image-2](./image/router-image-2.png)

### 出流量

出流量规则代表的是当服务作为主调方时，控制对所有的被调方进行流量转发的规则。

![router-image-3](./image/router-image-3.png)


## 属性

- Routing

| 名称      | 类型    | 描述               | 是否必选 |
| --------- | ------- | ------------------ | -------- |
| namespace | string  | 规则所属的命名空间 | 是       |
| service   | string  | 规则所属的服务     | 是       |
| inbounds  | Route[] | 入流量规则         | 否       |
| outbounds | Route[] | 出流量规则         | 否       |

- Route

| 名称         | 类型          | 描述                   | 是否必选 |
| ------------ | ------------- | ---------------------- | -------- |
| sources      | Source[]      | 来源请求匹配条件       | 否       |
| destinations | Destination[] | 目标服务的路由分发配置 | 是       |

- Source

| 名称      | 类型                     | 描述                     | 是否必选 |
| --------- | ------------------------ | ------------------------ | -------- |
| namespace | string                   | 匹配请求所属的源命名空间 | 否       |
| service   | string                   | 匹配请求所属的源服务     | 否       |
| metadata  | map<string, MatchString> | 匹配请求所带的标签       | 否       |

- Destination

| 名称      | 类型                     | 描述                                   | 是否必选 |
| --------- | ------------------------ | -------------------------------------- | -------- |
| namespace | string                   | 目标服务命名空间                       | 是       |
| service   | string                   | 目标服务名                             | 是       |
| metadata  | map<string, MatchString> | 目标服务分组标识                       | 是       |
| priority  | uint32                   | 目标分组的优先级，优先返回高优先级分组 | 否       |
| weight    | uint32                   | 目标分组的权重，请求按权重进行分发     | 否       |
| isolate   | bool                     | 是否隔离该目标分组                     | 否       |

