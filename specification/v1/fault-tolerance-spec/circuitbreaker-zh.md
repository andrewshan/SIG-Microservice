# 熔断降级

[English](./circuitbreaker.md) | 简体中文

---

## 定义

故障熔断，指的是当下游因过载或者BUG等原因，出现请求错误后，为了防止故障级联扩散导致整个链路出现异常，从而对请求进行拒绝或者重试的一种机制。

## 熔断模型

熔断模型的设计遵循业界标准的熔断器模型设计。熔断器有3类状态：

- 关闭：所有请求皆可访问下游资源，无任何限制。
- 打开：限制访问下游资源的请求，不允许任何请求的访问。
- 半开：限制访问下游资源的请求，只允许部分请求达到下游。

![](https://martinfowler.com/bliki/images/circuitBreaker/state.png)

## 触发熔断的条件

#### 连续错误数熔断

请求调用时，统计周期内，出现连续异常数目超过阈值之后，资源进入熔断状态。
polaris、CloudWeGo已支持。

#### 错误率熔断

熔断器按照滑窗对请求总数及成功数进行统计，并汇总时间段内的总错误率，一旦超过阈值，资源进入熔断状态。
go-zero、polaris、CloudWeGo已支持。

#### 错误数熔断

熔断器按照滑窗对请求总数及成功数进行统计，并汇总时间段内的总错误数，一旦超过阈值，资源进入熔断状态。
CloudWeGo已支持。

#### 连续错误数熔断

请求调用时，统计周期内，出现连续异常数目超过阈值之后，资源进入熔断状态。
polaris、CloudWeGo已支持。

#### 慢调用率熔断

熔断器按照滑窗对请求总数及慢调用数进行统计，并汇总时间段内的总慢请求率，一旦超过阈值，资源进入熔断状态。
polaris已支持。

## 熔断粒度

### 服务级熔断

按照服务粒度进行熔断统计，服务一般对应的是注册中心上注册的服务，实际对应到业务可以是应用或者模块。

### 方法级熔断

按照服务下提供的方法进行熔断统计，方法被熔断后会对请求进行拒绝或者走降级逻辑。

### 分组级熔断

按照服务实例分组进行熔断统计，实例分组被熔断后，请求往往会重路由到其他实例分组。

### 实例级熔断

按照具体的服务实例进行熔断统计，实例被熔断后，请求往往会重路由到其他实例。

## 熔断算法

业界熔断算法一般归为两类：

- 快速失败熔断：一旦触发熔断，则接下来的熔断周期内对资源的访问会自动地被拒绝或重路由。代表的算法有[Hystrix](https://github.com/Netflix/Hystrix/wiki)。
- 自适应熔断：出现错误时，会按照错误率的比例，渐进式的丢弃一部分的请求，直到丢弃的请求数无限接近100%（完全熔断）。代表的算法有[谷歌SRE](https://sre.google/sre-book/handling-overload/)

### 快速失败熔断

polaris、CloudWeGo已支持


#### 算法实现

![](pic/failfast_cb.png)

每个请求进入后，会判断熔断器状态，存在3种分支：

- 熔断器打开后，请求直接返回，走降级逻辑。
- 熔断器半开，则只需要一定量的请求访问下游，其他请求返回。
- 熔断器打开，所有请求都可以访问下游。

在请求调用后，通过框架采集请求的调用结果，汇聚熔断器。

熔断器会通过滑窗的方式，统计每个请求的成功数及总请求数，根据成功失败率进行状态转换：

-  熔断器从关闭到打开：一旦请求达到阈值，则熔断器打开。
-  熔断器从打开到半开：熔断器打开经过一段时间，或者通过了故障探测，则进入半开状态。
-  熔断器从半开到打开：熔断器半开后，走递增放量的方式，放量期间出现了失败，则熔断器重新打开。
-  熔断器从半开到关闭：熔断器半开后，走递增放量的方式，放量期间没有失败，最终放量100%后，熔断器关闭。

#### 属性值

| 属性                      | 类型 | 含义                                                         |
| ------------------------- | ---- | ------------------------------------------------------------ |
| protectThreshold          | int  | 熔断的保护阈值，只有请求量到达该阈值才触发熔断，保护小QPS的业务不被误伤 |
| errorRatioThreshold       | int  | 触发熔断的错误率阈值                                         |
| consecutiveErrorThreshold | int  | 触发连续错误数熔断的错误数阈值                               |
| errorCountThreshold       | int  | 触发熔断的错误数阈值                                         |
| slowRatioThreshold        | int  | 触发熔断的慢调用阈值                                         |
| maxDelay                  | long | 超过该时延阈值的请求属于慢调用请求                           |
| sleepWindow               | long | 熔断时长，单位毫秒                                           |
| statInteval               | long | 统计时长，单位毫秒                                           |
| statBucket                | int  | 滑窗的个数                                                   |
| recoverRatio              | int  | 半开后放量比例                                               |



### 自适应熔断

go-zero已支持

#### 算法实现

熔断器会通过滑窗的方式 ，统计请求的总数，以及成功数。

每个请求进入后，熔断器会通过以下公式进行计算，本次请求是否允许通过：

![](https://lh3.googleusercontent.com/S-HeyVOL7ZbrEPaCmKMoJelAKDntPKvNp0j3q7_n_o-At5efdDLhR6Rd_N9Oj9HfMLLjtYu-XBQK34UJrDWPuXOA4eSU0kI-iOP0zg=s295)

当结果为0，则全放通。否则，则按照计算结果百分比，通过区间算法，对请求进行限制（比如k=2，则错误率超过50%时，触发熔断），最终会无限趋向于1，熔断器进入打开状态。

熔断器打开后，随着少量请求的进入，通过统计请求的成功率，逐步放开放量阈值，直到熔断器关闭，请求全放通。

#### 属性值

| 属性             | 类型  | 含义                                                         |
| ---------------- | ----- | ------------------------------------------------------------ |
| protectThreshold | int   | 熔断的保护阈值，只有请求量到达该阈值才触发熔断，保护小QPS的业务不被误伤 |
| k                | float | 熔断算法的错误率因子，用于计算熔断器是否需要对请求进行拦截   |
| statInteval      | long  | 统计时长，单位毫秒                                           |
| statBucket       | int   | 滑窗的个数                                                   |

## 熔断规则

| 属性            | 类型   | 含义                                     |
| --------------- | ------ | ---------------------------------------- |
| destination     | struct | 被调资源信息（服务名、命名空间、方法名） |
| .namespace      | string | 被调命名空间                             |
| .service        | string | 被调服务名                               |
| .method         | string | 被调方法名                               |
| source          | struct | 主调信息（服务名、命名空间、请求标签）   |
| .namespace      | string | 主调命名空间                             |
| .service        | string | 主调命名空间                             |
| .labels         | map    | 主调请求标签                             |
| resource        | enum   | 资源类型（服务、接口、分组、实例）       |
| policy          | enum   | 熔断策略（上文所述的熔断策略）           |
| breaker         | enum   | 熔断器类型（快速失败、自适应）           |
| failFastConfig  | struct | 快速失败熔断器配置                       |
| throttingConfig | struct | 自适应熔断器配置                         |












