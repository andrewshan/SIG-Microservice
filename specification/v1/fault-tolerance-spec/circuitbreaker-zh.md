# 熔断降级

[English](./circuitbreaker.md) | 简体中文

---

## 定义

故障熔断的是北极星提供的一种在主调方侧迅速自动屏蔽错误率高或故障的服务实例，防止故障扩散，提升业务成功率的一种机制。

故障熔断默认开启。如果一个被调连续错误```n```次 或 最近一分钟请求大于```n```且错误率大于50%  则触发故障熔断。

注意：节点熔断后，过一个时间间隔会进入半开状态释放少量请求进行恢复探测，用户可根据自己需求配置网络探测，网络探测成功以后才进入半开。或者调大进入半开探测恢复的时间间隔。

### 熔断的机制

![](https://polarismesh.cn/assets/img/cb_flow.7757a297.png)

#### 连续错误数熔断
在统计周期内，连续异常数目超过阈值之后，节点进入熔断状态，即在接下的时间窗口，该节点不参与调度。

#### 错误率熔断
当资源的每分钟请求量 >= ```n```，并且每分钟异常总数占通过量的比值超过阈值之后，节点进入熔断状态，即在接下的时间窗口，该节点不参与调度。

#### 半开机制

节点进入熔断状态后，通过以下2个途径，该熔断节点会进入半开状态（业务探测状态）。

即在接下来统计周期中，该节点会被允许调度少量的业务请求。当这些业务请求的成功率符合阈值，节点才会正式恢复：

通过主动探测进入半开：假如用户开启了主动探测（默认不开启），则SDK内部会启动定时任务，对熔断的节点进行探测，探测通过后，节点进入半开状态；
通过超时进入半开：用户没有开启主动探测的前提下，熔断的节点在时间窗过了后，会自动进入半开状态。

#### 异常保护机制

为了防止网络闪断导致集群节点全熔断，从而由于无可用节点导致业务路由失败的情况发生，需要加入异常保护机制：当某个路由目标集群剩余健康节点数据达到了一定百分比阈值了，需要默认放通该目标集群的所有实例。

## 属性

| 名称      | 类型     | 描述               | 是否必选 |
| --------- | -------- | ------------------ | -------- |
| namespace | string   | 规则所属的命名空间 | 是       |
| service   | string   | 规则所属的服务     | 是       |
| inbounds  | CbRule[] | 入流量的熔断规则   | 否       |
| outbounds | CbRule[] | 出流量的熔断规则   | 否       |






