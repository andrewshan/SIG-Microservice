# 健康检查

[English](./healthcheck.md) | 简体中文

---

## 定义

健康检查提供了一种机制，使得控制面可以在一定时间段内，感知服务实例出现异常，从而将异常节点剔除，并通知给所有的消费者。健康检查有以下2种实现形式：

### 心跳上报

服务实例持续上报心跳给控制面，并与控制面约定TTL的时间段，控制面检查服务实例的心跳上报时间点，当发现当前时间相比实例最后一次上报时间已经超过```n*TTL```，就将实例标记为不健康，并通知给该服务的消费者。

### 主动探测

服务实例与控制面约定探测的方式（探测协议、接口、超时等）。控制面会定时探测服务实例的接口，当发现探测失败次数超过```n```，就将实例标记为不健康，并通知给该服务的消费者。

## 属性

- HealthCheck

| 名称         | 类型        | 描述                           | 是否必选 |
| ------------ | ----------- | ------------------------------ | -------- |
| type         | enum        | 探测类型：1心跳上报，2主动探测 | 是       |
| heartbeat    | Heartbeat   | 心跳上报相关的配置             | 否       |
| active_check | ActiveCheck | 主动探测相关的配置             | 否       |

- Heartbeat

| 名称                | 类型 | 描述                            | 是否必选 |
| ------------------- | ---- | ------------------------------- | -------- |
| ttl                 | int  | 心跳上报的超时TTL               | 是       |
| unhealthy_threshold | int  | 多少个TTL没有收到心跳转成不健康 | 否       |
| healthy_threshold   | int  | 多少个TTL持续收到心跳转成健康   | 否       |

- ActiveCheck

| 名称                | 类型 | 描述                        | 是否必选 |
| ------------------- | ---- | --------------------------- | -------- |
| protocol            | enum | 探测协议：http/grpc/tcp/udp | 是       |
| timeout             | int  | 探测超时时间                | 是       |
| interval            | int  | 探测间隔                    | 是       |
| unhealthy_threshold | int  | 多少次探测失败后转成不健康  | 否       |
| healthy_threshold   | int  | 多少次探测成功后转成不健康  | 否       |